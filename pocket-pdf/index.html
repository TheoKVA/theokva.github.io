<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket PDF</title>

    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/jscanify"></script> -->

    <script src="https://cdn.jsdelivr.net/npm/heic2any/dist/heic2any.min.js"></script>

    <script src="https://docs.opencv.org/4.7.0/opencv.js" async></script>
    <script src="https://cdn.jsdelivr.net/gh/ColonelParrot/jscanify@master/src/jscanify.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        #js-preview {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        #js-preview > * {
            margin: 10px;
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 200px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Pocket PDF</h1>
    <p>Upload or take photos of your documents to assemble them into a PDF.</p>

    <input id="js-fileInput" type="file" accept="image/*" capture="environment" multiple>

    <div id="js-preview"></div>
    
    <button id="btn-generate">Generate PDF</button>
    <button id="btn-download" disabled>Download PDF</button>

    
</body>

<script>

    // HTML
    const fileInputDIV = document.getElementById('js-fileInput');
    const previewDIV = document.getElementById('js-preview');
    const bttnGenerate = document.getElementById('btn-generate');
    const bttnDownload = document.getElementById('btn-download');

    // Initiates libraries
    const reader = new FileReader();
    const scanner = new jscanify();
    
    // INPUT
    const paperWidthMM = 210;
    const paperHeightMM = 297;
    const paperDPI = 300 
    const paperWidth = Math.round( paperWidthMM / 25.4 * paperDPI); // in PX
    const paperHeight = Math.round( paperHeightMM / 25.4 * paperDPI); // in PX

    // VARIABLES
    const imagesScanned = [];


    // FILE INPUT
    fileInputDIV.addEventListener('change', async (event) => {

        console.log('fileInputDIV - Change');

        const files = event.target.files;
        console.log('Files:', files);

        for (const file of files) {
            console.log('Processing file:', file.name);

            const reader = new FileReader();
            reader.onload = async (e) => {
                console.log('FileReader onload event triggered.');

                let imgSrc = e.target.result;

                // If the file is HEIC, convert it
                if (file.type === 'image/heic' || file.type === 'image/heif') {
                    console.log('HEIC image detected');
                    try {
                        const heicToJpg = await heic2any({ blob: file, toType: 'image/jpeg' });
                        imgSrc = URL.createObjectURL(heicToJpg);
                        console.log('HEIC image converted to JPEG:');
                    } catch (error) {
                        console.error('Error converting HEIC to JPEG:', error);
                    }
                }

                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    console.log('Image loaded for processing:');

                    // Convert image to OpenCV mat
                    const mat = cv.imread(img);
                    console.log('Converted image to cv.Mat.');

                    // Find the paper contour
                    const contour = scanner.findPaperContour(mat);
                    console.log('Paper contour detected:', contour);

                    // Get corner points from the contour
                    const cornerPoints = scanner.getCornerPoints(contour);
                    console.log('Corner points detected:', cornerPoints);

                    const processedCanvas = scanner.extractPaper(img, paperWidth, paperHeight);
                    console.log('Processed canvas generated by jscanify.');

                    // Append the output canvas to image
                    imagesScanned.push({
                        'sourceImage': img,
                        'cornerPoints': cornerPoints,
                        'processedImage': processedCanvas,
                    })

                    // Display preview images in previewDIV
                    previewDIV.appendChild(processedCanvas);
                    console.log('Processed image preview added to the page.');
                };
            };

            reader.readAsDataURL(file);
        }
    });


    // GENERATE PDF
    bttnGenerate.addEventListener('click', async () => {

        console.log('Generate PDF button clicked.');
        const pdfDoc = await PDFLib.PDFDocument.create();
        console.log('PDF document created.');

        // On scroll dans toutes les images
        for (const imageScanned of imagesScanned) {

            // Chope la version processed
            const image = imageScanned.processedImage
            console.log('Embedding image into PDF:', image);
            
            const imgBytes = await fetch(image.toDataURL('image/jpeg')).then((res) => res.arrayBuffer());
            console.log(imgBytes);

            const pdfImage = await pdfDoc.embedJpg(imgBytes);
            console.log('Image embedded as JPEG in PDF:');

            const page = pdfDoc.addPage([pdfImage.width, pdfImage.height]);
            page.drawImage(pdfImage, {
                x: 0,
                y: 0,
                width: pdfImage.width,
                height: pdfImage.height,
            });
            console.log('Image drawn on PDF page.');
        }

        // --------------
        // --------------

        const pdfBytes = await pdfDoc.save(); // Save as raw bytes
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        bttnDownload.disabled = false; // Enable the button

        // iOS-specific handling
        if (isIOS()) {
            // Enable the Share button for supported devices
            if (navigator.share) {
                const file = new File([blob], "document.pdf", { type: 'application/pdf' });
                bttnDownload.addEventListener("click", async () => {
                    try {
                        // Use the Share API
                        await navigator.share({
                            title: "My PDF Document",
                            text: "Here is the PDF document I generated.",
                            files: [file], // Share the PDF file
                        });
                        console.log("PDF shared successfully!");
                    } catch (error) {
                        console.error("Error sharing PDF:", error);
                    }
                });
            } 
            else {
                const downloadLinkIOS = document.createElement('a');
                downloadLinkIOS.href = URL.createObjectURL(blob);
                downloadLinkIOS.download = 'document.pdf';
                downloadLinkIOS.style = 'display: none'; // Invisible link

                // Append and prepare for manual trigger
                document.body.appendChild(downloadLinkIOS);
                bttnDownload.addEventListener("click", function () {
                    downloadLinkIOS.click(); // Trigger the download
                });
            }
        } else {
            // Handling for other platforms
            const blobUrl = URL.createObjectURL(blob);

            // Update download button
            bttnDownload.href = blobUrl;
            bttnDownload.download = 'document.pdf';

            // Try to open in a new tab (optional fallback)
            const pdfWindow = window.open(blobUrl);
            if (!pdfWindow) {
                console.warn('Popup blocked. Download link enabled instead.');
            }
        }
    });






    // HELPER

    const ios = () => {
        if (typeof window === `undefined` || typeof navigator === `undefined`) return false;
        return /iPhone|iPad|iPod/i.test(navigator.userAgent || navigator.vendor || (window.opera && opera.toString() === `[object Opera]`));
    };

    // Check for iOS platform
    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

</script>

</html>

